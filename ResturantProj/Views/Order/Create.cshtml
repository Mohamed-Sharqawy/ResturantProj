@model ResturantProj.Models.Order
@{
    ViewData["Title"] = "Create Order";
    var menuItems = ViewBag.MenuItems as List<ResturantProj.Models.MenuItem>;
}

<style>
    :root {
        --cozy-red: #a4161a;
        --dark-red: #6a040f;
        --light-bg: #f8f5f2;
        --dark-text: #333333;
    }

    body {
        background-color: var(--light-bg);
        color: var(--dark-text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    main {
        flex: 1;
        padding-bottom: 40px;
    }

    h2 {
        color: var(--dark-red);
        font-family: 'Georgia', serif;
        margin-bottom: 1.5rem;
        font-weight: 700;
        text-align: center;
    }

    h4 {
        color: var(--cozy-red);
        border-bottom: 2px solid var(--cozy-red);
        padding-bottom: 6px;
        margin-bottom: 1.25rem;
        font-weight: 600;
    }

    .menu-card-order {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease, box-shadow 0.3s ease;
        background-color: #fff;
    }

        .menu-card-order:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

    .card-img-top-order {
        height: 180px;
        object-fit: cover;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
    }

    .card-title {
        color: var(--dark-red);
        font-weight: bold;
        font-size: 1.2rem;
    }

    .price-tag {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--cozy-red);
    }

    .availability {
        font-size: 0.9rem;
        color: #555;
        margin-top: 5px;
    }

    .low-stock {
        color: #c1121f;
        font-weight: bold;
    }

    .summary-card {
        background-color: #fff;
        border: none;
        border-radius: 15px;
        padding: 1.25rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

        .summary-card hr {
            border-top: 1px solid rgba(164, 22, 26, 0.3);
        }

    .btn-primary {
        background-color: var(--cozy-red);
        border-color: var(--cozy-red);
    }

        .btn-primary:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
        }

    .menu-item-checkbox {
        width: 1.1rem;
        height: 1.1rem;
        border: 2px solid var(--cozy-red);
        border-radius: 4px;
        background-color: white;
        margin-top: 0.3rem;
    }

        .menu-item-checkbox:checked {
            background-color: var(--cozy-red);
            border-color: var(--dark-red);
        }

            .menu-item-checkbox:checked[type=checkbox] {
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10l3 3l6-6'/%3e%3c/svg%3e");
            }

    .form-check-label {
        font-weight: 600;
        color: var(--dark-red);
        cursor: pointer;
    }

    .qty-input {
        text-align: center;
        width: 70px;
        border: 1px solid var(--cozy-red);
        border-radius: 5px;
        background-color: var(--light-bg);
        color: var(--dark-text);
        font-weight: 500;
        transition: border-color 0.3s ease;
    }

        .qty-input:focus {
            border-color: var(--dark-red);
            box-shadow: 0 0 0 0.25rem rgba(164, 22, 26, 0.25);
        }

        .qty-input:disabled {
            opacity: 0.6;
            background-color: #eee;
        }

    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
        padding: 0.6rem 0.9rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
</style>

<main>
    <h2>Create Your Cozy Order</h2>

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()

        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-lg-4 mb-4">
                <div class="p-3 shadow-sm bg-white rounded mb-4">
                    <h4>Order Details</h4>

                    <div class="form-group mb-3">
                        <label asp-for="OrderType" class="form-label fw-bold"></label>
                        <select asp-for="OrderType" class="form-control" id="OrderType">
                            <option disabled selected value="">-- Select Order Type --</option>
                            <option value="0">Dine In</option>
                            <option value="1">Takeout</option>
                            <option value="2">Delivery</option>
                        </select>
                        <span asp-validation-for="OrderType" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3" id="addressField" style="display:none;">
                        <label for="DeliveryAddress" class="form-label fw-bold">Delivery Address</label>
                        <input type="text" class="form-control" name="DeliveryAddress" id="DeliveryAddress" />
                        <span asp-validation-for="DeliveryAddress" class="text-danger"></span>
                    </div>

                    <hr />

                    <div class="card summary-card shadow-sm">
                        <h5 class="fw-bold mb-3">Order Summary</h5>
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="subtotal-display" class="price-tag">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Discount:</span>
                            <span id="discount-display" class="price-tag">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Tax (8%):</span>
                            <span id="tax-display">$0.00</span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Total:</span>
                            <span id="total-display" class="price-tag">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu Section -->
            <div class="col-lg-8">
                <h4>Select Your Comfort Food</h4>
                <div id="warning-box" class="alert-warning" style="display:none;"></div>

                <div class="row row-cols-1 row-cols-md-2 g-4">
                    @for (int i = 0; i < menuItems.Count; i++)
                    {
                        var item = menuItems[i];
                        <div class="col">
                            <div class="card menu-card-order h-100">
                                <img src="@item.ImgUrl" class="card-img-top-order" alt="@item.Name" />
                                <div class="card-body">
                                    <h5 class="card-title">@item.Name</h5>
                                    <p class="card-text"><small class="text-muted">@item.Category?.Name</small></p>
                                    <p class="availability">
                                        Available today:
                                        <span class="@(item.DailyOrderCount <= 5 ? "low-stock" : "")">
                                            @item.DailyOrderCount
                                        </span>
                                    </p>

                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <p class="card-text price-tag m-0">$@item.Price</p>
                                        <div class="d-flex align-items-center">
                                            <div class="form-check me-3">
                                                <input type="checkbox"
                                                       name="SelectedMenuItemIds"
                                                       value="@item.Id"
                                                       class="form-check-input menu-item-checkbox"
                                                       id="select_@i"
                                                       data-index="@i"
                                                       data-price="@item.Price"
                                                       data-available="@item.DailyOrderCount" />
                                                <label class="form-check-label" for="select_@i">Add</label>
                                            </div>

                                            <div>
                                                <input type="number"
                                                       min="1"
                                                       value="1"
                                                       class="form-control form-control-sm qty-input"
                                                       name="Quantities"
                                                       data-index="@i" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <hr class="mt-5" />

        <input type="hidden" name="SubTotal" id="subtotal-input" value="0" />
        <input type="hidden" name="DiscountAmount" id="discount-input" value="0" />
        <input type="hidden" name="TaxAmount" id="tax-input" value="0" />
        <input type="hidden" name="Total" id="total-input" value="0" />

        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary btn-lg">Complete Order</button>
            <a asp-action="Index" asp-controller="MenuItem" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
    </form>
</main>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.getElementById("OrderType").addEventListener("change", function () {
            document.getElementById("addressField").style.display = (this.value === "2") ? "block" : "none";
        });

        const checkboxes = document.querySelectorAll(".menu-item-checkbox");
        const qtyInputs = document.querySelectorAll(".qty-input");
        const TAX_RATE = 0.08;
        const warningBox = document.getElementById("warning-box");

        function calculateDiscount(subtotal) {
            const now = new Date();
            const hour = now.getHours();
            let discount = 0;

            if (hour >= 15 && hour < 17) discount += subtotal * 0.20;
            if ((subtotal - discount) > 100) discount += (subtotal - discount) * 0.10;
            return discount;
        }

        function calculateTotals() {
            let subtotal = 0;
            let warnings = [];

            checkboxes.forEach((cb, i) => {
                const qtyInput = qtyInputs[i];
                qtyInput.disabled = !cb.checked;

                if (cb.checked) {
                    const price = parseFloat(cb.dataset.price);
                    const available = parseInt(cb.dataset.available);
                    const qty = parseInt(qtyInput.value) || 1;

                    if (qty > available) {
                        warnings.push(`Only ${available} left for "${cb.id.replace('select_', '')}".`);
                        qtyInput.value = available;
                    }

                    subtotal += price * qty;
                }
            });

            const discount = calculateDiscount(subtotal);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax - discount;

            document.getElementById("subtotal-display").textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById("discount-display").textContent = `-$${discount.toFixed(2)}`;
            document.getElementById("tax-display").textContent = `$${tax.toFixed(2)}`;
            document.getElementById("total-display").textContent = `$${total.toFixed(2)}`;

            document.getElementById("subtotal-input").value = subtotal.toFixed(2);
            document.getElementById("discount-input").value = discount.toFixed(2);
            document.getElementById("tax-input").value = tax.toFixed(2);
            document.getElementById("total-input").value = total.toFixed(2);

            warningBox.style.display = warnings.length ? "block" : "none";
            warningBox.innerHTML = warnings.join("<br>");
        }

        checkboxes.forEach(cb => cb.addEventListener("change", calculateTotals));
        qtyInputs.forEach(q => q.addEventListener("input", calculateTotals));

        calculateTotals();
    </script>
}
